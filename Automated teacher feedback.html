<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教師評語產生系統</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Sans TC", "Microsoft JhengHei";
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .input-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .student-name-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .student-name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .evaluation-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .evaluation-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .evaluation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .evaluation-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .score-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }

        .score-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .score-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 45px;
        }

        .score-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .score-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .score-btn.no-score {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .example-input-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .example-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .example-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .example-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .example-hint {
            display: block;
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        .tone-selection, .style-selection {
            margin-top: 30px;
            padding: 25px;
            background: #f0f4ff;
            border-radius: 8px;
            border: 2px solid #e0e6ff;
        }

        .tone-selection {
            background: #f0f8ff;
            border-color: #b3d9ff;
        }

        .tone-label, .style-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        .tone-options, .style-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tone-option, .style-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .tone-option .tone-content,
        .style-option .style-content {
            flex: 1;
        }

        .tone-option:hover, .style-option:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .tone-option input[type="radio"], .style-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
        }

        .tone-option input[type="radio"]:checked + .tone-content .tone-name,
        .style-option input[type="radio"]:checked + .style-content .style-name {
            color: #667eea;
            font-weight: 600;
        }

        .tone-option input[type="radio"]:checked + .tone-content .tone-desc,
        .style-option input[type="radio"]:checked + .style-content .style-desc {
            color: #667eea;
        }

        .tone-name, .style-name {
            display: block;
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }

        .tone-desc, .style-desc {
            display: block;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .generate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 30px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .result-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #17a2b8;
        }

        .comment-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #333;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-bottom: 30px;
        }

        .radar-chart-section {
            margin-top: 20px;
        }

        .radar-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .radar-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #9370DB;
        }

        .reset-btn {
            padding: 10px 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* 版本選擇樣式 */
        .version-selection {
            margin: 30px 0;
            padding: 25px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 2px solid #b3d9ff;
        }

        .version-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: block;
        }

        .version-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .version-option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .version-option:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .version-option input[type="radio"] {
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
        }

        .version-option input[type="radio"]:checked + .version-content .version-name {
            color: #667eea;
            font-weight: 600;
        }

        .version-option input[type="radio"]:checked + .version-content .version-desc {
            color: #667eea;
        }

        .version-content {
            flex: 1;
        }

        .version-name {
            display: block;
            font-weight: 500;
            margin-bottom: 4px;
            color: #333;
        }

        .version-desc {
            display: block;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .version-section {
            margin-top: 20px;
        }

        /* 四字成語版本樣式 */
        .idiom-categories {
            margin-bottom: 30px;
        }

        .categories-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .category-item:hover {
            border-color: #9370DB;
            box-shadow: 0 4px 12px rgba(147, 112, 219, 0.1);
        }

        .category-item h4 {
            color: #9370DB;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .subcategories {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .subcategories label {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            color: #555;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .subcategories label:hover {
            background-color: rgba(147, 112, 219, 0.1);
        }

        .subcategories input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .subcategories input[type="checkbox"]:checked + span {
            color: #9370DB;
            font-weight: 500;
        }

        /* 生成的成語結果樣式 */
        .idiom-result {
            background: #f0f4ff;
            border: 2px solid #9370DB;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .idiom-result h4 {
            color: #9370DB;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .idiom-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .idiom-item {
            background: white;
            border: 1px solid #9370DB;
            border-radius: 6px;
            padding: 8px 12px;
            color: #9370DB;
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* 檔案上傳區域樣式 */
        .file-upload-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 10px;
            border: 2px dashed #9370DB;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload-section:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .file-upload-section.dragover {
            background: #e8f2ff;
            border-color: #667eea;
        }

        .upload-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #9370DB;
            margin-bottom: 15px;
        }

        .upload-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-btn {
            padding: 12px 24px;
            background: #9370DB;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-btn:hover {
            background: #764ba2;
            transform: translateY(-1px);
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 0.9rem;
            color: #666;
        }

        /* 學生列表區域樣式 */
        .student-list-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: none;
        }

        .student-list-section.show {
            display: block;
        }

        .student-list-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-count {
            font-size: 1rem;
            color: #9370DB;
            font-weight: normal;
        }

        /* 學生選擇器樣式 */
        .student-selector-container {
            margin-bottom: 25px;
        }

        .selector-label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .selector-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .student-selector {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .student-selector:focus {
            outline: none;
            border-color: #9370DB;
            box-shadow: 0 0 0 3px rgba(147, 112, 219, 0.1);
        }

        .student-selector option {
            padding: 8px;
            font-size: 14px;
        }

        .student-selector option[data-status="unrated"] {
            color: #dc3545;
        }

        .student-selector option[data-status="rated"] {
            color: #ffc107;
        }

        .student-selector option[data-status="completed"] {
            color: #28a745;
        }

        .student-selector option[data-status="active"] {
            color: #007bff;
            font-weight: bold;
        }

        .selector-search {
            flex: 1;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #9370DB;
            box-shadow: 0 0 0 3px rgba(147, 112, 219, 0.1);
        }

        /* 學生狀態統計樣式 */
        .student-stats {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            font-size: 1.2rem;
            margin-bottom: 8px;
            display: block;
        }

        .stat-label {
            display: block;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-count {
            display: block;
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .current-student-indicator {
            background: #f0f4ff;
            border: 2px solid #9370DB;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-student-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #9370DB;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .batch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .batch-btn.export {
            background: #28a745;
            color: white;
        }

        .batch-btn.export:hover {
            background: #218838;
        }

        .batch-btn.overview {
            background: #17a2b8;
            color: white;
        }

        .batch-btn.overview:hover {
            background: #138496;
        }

        /* 批量結果總覽樣式 */
        .batch-overview-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: none;
        }

        .batch-overview-section.show {
            display: block;
        }

        .overview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .overview-table th,
        .overview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .overview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .overview-table tr:hover {
            background: #f8f9fa;
        }

        .overview-table td.student-name-cell {
            font-weight: 500;
            color: #9370DB;
            cursor: pointer;
        }

        .overview-table td.student-name-cell:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .score-cell {
            text-align: center;
            font-weight: 500;
        }

        .score-cell.scored {
            color: #28a745;
        }

        .score-cell.unscored {
            color: #dc3545;
        }

        /* 評語儲存按鈕樣式 */
        .save-comment-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .save-comment-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .save-comment-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .comment-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 500;
        }

        .comment-status.saved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .comment-status.unsaved {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .comment-metadata {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .selector-wrapper {
                flex-direction: column;
                gap: 10px;
            }
            
            .student-selector {
                min-width: auto;
            }
            
            .selector-search {
                min-width: auto;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .style-options {
                justify-content: center;
            }
            
            .style-option {
                flex-direction: column;
                text-align: center;
            }
            
            .style-option input[type="radio"] {
                margin: 0 auto 8px auto;
            }
            
            .score-buttons {
                justify-content: center;
            }
            
            .result-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>教師評語產生系統</h1>
            <p>透過六個向度的評分，快速生成正向鼓勵的學生評語</p>
        </div>

        <!-- 檔案上傳區域 -->
        <div class="file-upload-section" id="fileUploadSection">
            <h2 class="upload-title">匯入學生名單</h2>
            <p class="upload-description">支援 CSV、XLS、XLSX 格式檔案，系統會自動讀取第一列作為學生姓名</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xls,.xlsx" onchange="handleFileUpload(event)">
                <button class="file-input-btn">選擇檔案</button>
            </div>
            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-details" id="fileDetails"></div>
            </div>
        </div>

        <!-- 學生列表區域 -->
        <div class="student-list-section" id="studentListSection">
            <div class="student-list-title">
                學生名單
                <span class="student-count" id="studentCount">共 0 位學生</span>
            </div>
            
            <!-- 學生選擇下拉選單 -->
            <div class="student-selector-container">
                <label for="studentSelector" class="selector-label">選擇學生進行評分：</label>
                <div class="selector-wrapper">
                    <select id="studentSelector" class="student-selector" onchange="handleStudentSelection(this.value)">
                        <option value="">-- 請選擇學生 --</option>
                    </select>
                    <div class="selector-search">
                        <input type="text" id="studentSearch" class="search-input" placeholder="搜尋學生姓名..." onkeyup="filterStudents(this.value)" onkeydown="handleSearchKeydown(event)">
                    </div>
                </div>
            </div>
            
            <!-- 學生狀態統計 -->
            <div class="student-stats" id="studentStats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-icon">🔴</span>
                        <span class="stat-label">未評分</span>
                        <span class="stat-count" id="unratedCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🟡</span>
                        <span class="stat-label">已評分</span>
                        <span class="stat-count" id="ratedCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">🟢</span>
                        <span class="stat-label">已完成</span>
                        <span class="stat-count" id="completedCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">📊</span>
                        <span class="stat-label">完成率</span>
                        <span class="stat-count" id="completionRate">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="batch-actions">
                <button class="batch-btn overview" onclick="toggleBatchOverview()">查看總覽</button>
                <button class="batch-btn export" onclick="exportResults()">匯出結果</button>
            </div>
        </div>

        <!-- 批量結果總覽區域 -->
        <div class="batch-overview-section" id="batchOverviewSection">
            <h2 class="result-title">學生評分總覽</h2>
            <table class="overview-table" id="overviewTable">
                <thead>
                    <tr>
                        <th>學生姓名</th>
                        <th>上課態度</th>
                        <th>考試分數</th>
                        <th>筆記分數</th>
                        <th>同儕關係</th>
                        <th>自主學習</th>
                        <th>生活常規</th>
                        <th>評語狀態</th>
                        <th>評語類型</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 資料將由 JavaScript 動態生成 -->
                </tbody>
            </table>
        </div>

        <div class="input-section">
            <!-- 當前學生指示器 -->
            <div class="current-student-indicator" id="currentStudentIndicator" style="display: none;">
                <div>正在評分：<span class="current-student-name" id="currentStudentName"></span></div>
            </div>
            
            <div class="form-group">
                <label for="studentName">學生姓名</label>
                <input type="text" id="studentName" class="student-name-input" placeholder="請輸入學生姓名或從上方學生列表選擇">
            </div>

            <div class="version-selection">
                <label class="version-label">選擇評語版本</label>
                <div class="version-options">
                    <label class="version-option">
                        <input type="radio" name="commentVersion" value="scoring" checked>
                        <div class="version-content">
                            <span class="version-name">六向度評分版本</span>
                            <span class="version-desc">透過六個向度評分生成詳細評語</span>
                        </div>
                    </label>
                    <label class="version-option">
                        <input type="radio" name="commentVersion" value="idioms">
                        <div class="version-content">
                            <span class="version-name">四字成語版本</span>
                            <span class="version-desc">選擇不同類別，隨機生成四字成語評語</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 六向度評分版本界面 -->
            <div id="scoringSection" class="version-section">
                <div id="evaluationItems">
                    <!-- 評量項目將由 JavaScript 動態生成 -->
                </div>

                <div class="tone-selection">
                    <label class="tone-label">選擇評語語氣</label>
                    <div class="tone-options">
                        <label class="tone-option">
                            <input type="radio" name="commentTone" value="encouraging" checked>
                            <div class="tone-content">
                                <span class="tone-name">積極鼓勵</span>
                                <span class="tone-desc">充滿正能量的鼓勵性語句，適合日常激勵</span>
                            </div>
                        </label>
                        <label class="tone-option">
                            <input type="radio" name="commentTone" value="neutral">
                            <div class="tone-content">
                                <span class="tone-name">中性評價</span>
                                <span class="tone-desc">客觀事實的評價描述，適合正式評量</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="style-selection">
                    <label class="style-label">選擇評語風格</label>
                    <div class="style-options">
                        <label class="style-option">
                            <input type="radio" name="commentStyle" value="style1" checked>
                            <div class="style-content">
                                <span class="style-name">多樣化銜接詞</span>
                                <span class="style-desc">使用「在...方面」、「...的表現」等多樣化銜接</span>
                            </div>
                        </label>
                        <label class="style-option">
                            <input type="radio" name="commentStyle" value="style2">
                            <div class="style-content">
                                <span class="style-name">自然語句融合</span>
                                <span class="style-desc">不提向度名稱，直接描述表現</span>
                            </div>
                        </label>
                        <label class="style-option">
                            <input type="radio" name="commentStyle" value="style3">
                            <div class="style-content">
                                <span class="style-name">邏輯分組連接</span>
                                <span class="style-desc">將相關向度分組，用邏輯連接詞串聯</span>
                            </div>
                        </label>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateComment()">生成評語</button>
            </div>

            <!-- 四字成語版本界面 -->
            <div id="idiomsSection" class="version-section" style="display: none;">
                <div class="idiom-categories">
                    <h3 class="categories-title">選擇評語類別</h3>
                    <div class="categories-grid">
                        <div class="category-item" data-category="attitude">
                            <h4>學習態度類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="positive"><span>積極正面</span></label>
                                <label><input type="checkbox" data-subcategory="method"><span>學習方法</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="character">
                            <h4>品格修養類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="moral"><span>品德高尚</span></label>
                                <label><input type="checkbox" data-subcategory="honest"><span>誠實守信</span></label>
                                <label><input type="checkbox" data-subcategory="humble"><span>謙遜有禮</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="relationship">
                            <h4>人際關係類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="teamwork"><span>團隊合作</span></label>
                                <label><input type="checkbox" data-subcategory="leadership"><span>領導能力</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="personality">
                            <h4>性格特質類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="perseverance"><span>堅毅不拔</span></label>
                                <label><input type="checkbox" data-subcategory="cheerful"><span>開朗活潑</span></label>
                                <label><input type="checkbox" data-subcategory="steady"><span>穩重可靠</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="ability">
                            <h4>能力表現類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="academic"><span>學業成就</span></label>
                                <label><input type="checkbox" data-subcategory="diverse"><span>多元發展</span></label>
                                <label><input type="checkbox" data-subcategory="creative"><span>創新思維</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="progress">
                            <h4>進步鼓勵類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="improve"><span>持續改進</span></label>
                                <label><input type="checkbox" data-subcategory="potential"><span>潛力發揮</span></label>
                            </div>
                        </div>
                        <div class="category-item" data-category="special">
                            <h4>特殊表現類</h4>
                            <div class="subcategories">
                                <label><input type="checkbox" data-subcategory="art"><span>藝術才能</span></label>
                                <label><input type="checkbox" data-subcategory="sports"><span>體育專長</span></label>
                                <label><input type="checkbox" data-subcategory="service"><span>服務貢獻</span></label>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="generate-btn" onclick="generateIdiomComment()">生成四字成語評語</button>
            </div>
        </div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <h2 class="result-title">生成的評語</h2>
                <div>
                    <button class="copy-btn" onclick="copyComment()">複製評語</button>
                    <button class="save-comment-btn" id="saveCommentBtn" onclick="saveCurrentComment()">儲存評語</button>
                    <button class="copy-btn" id="regenerateIdiomBtn" onclick="regenerateIdioms()" style="display: none; background: #fd7e14;">重新生成</button>
                    <button class="reset-btn" onclick="resetForm()">重新開始</button>
                </div>
            </div>
            <div class="comment-text" id="commentText"></div>
            
            <!-- 評語狀態顯示 -->
            <div class="comment-status" id="commentStatus" style="display: none;">
                <span id="commentStatusText"></span>
                <div class="comment-metadata" id="commentMetadata"></div>
            </div>
            
            <div class="radar-chart-section">
                <h3 class="radar-title">能力雷達圖</h3>
                <div class="radar-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 四字成語資料
        const idiomData = {
            attitude: {
                positive: [
                    '勤勉向學', '用功認真', '學習認真', '用功努力', '勤學不懈',
                    '學而時習', '孜孜不倦', '好學不倦', '勤奮學習'
                ],
                method: [
                    '循序漸進', '溫故知新', '學思並重', '舉一反三', '觸類旁通'
                ]
            },
            character: {
                moral: [
                    '品學兼優', '德才兼備', '品格高尚', '品行端正', '操行良好',
                    '品德優良', '品性純良', '德行兼備'
                ],
                honest: [
                    '誠實可靠', '言行一致', '表裡如一', '誠懇待人'
                ],
                humble: [
                    '謙恭有禮', '謙虛好學', '謙遜有禮', '溫文儒雅', '彬彬有禮'
                ]
            },
            relationship: {
                teamwork: [
                    '團結合作', '樂於助人', '與人為善', '和睦相處', '友愛同學',
                    '關懷他人', '熱心助人', '服務熱忱'
                ],
                leadership: [
                    '領導有方', '組織能力', '統籌規劃', '領導才能'
                ]
            },
            personality: {
                perseverance: [
                    '堅持不懈', '百折不撓', '堅忍不拔', '意志堅定', '恆心毅力', '鍥而不捨'
                ],
                cheerful: [
                    '活潑開朗', '開朗大方', '天真活潑', '熱情開朗', '樂觀進取'
                ],
                steady: [
                    '穩重踏實', '成熟穩重', '沉穩內斂', '踏實認真'
                ]
            },
            ability: {
                academic: [
                    '成績優異', '學業進步', '突飛猛進', '名列前茅', '脫穎而出', '出類拔萃'
                ],
                diverse: [
                    '多才多藝', '文武雙全', '全面發展', '多方面發展', '德智體群'
                ],
                creative: [
                    '創意思考', '獨立思考', '思路清晰', '邏輯清楚'
                ]
            },
            progress: {
                improve: [
                    '更上層樓', '精益求精', '百尺竿頭', '日新又新', '力求上進'
                ],
                potential: [
                    '潛力無窮', '前程似錦', '後生可畏', '未來可期'
                ]
            },
            special: {
                art: [
                    '多才多藝', '文藝氣息', '藝術天分'
                ],
                sports: [
                    '文武兼備', '體魄強健', '運動細胞'
                ],
                service: [
                    '服務熱忱', '奉獻精神', '熱心服務', '公益服務'
                ]
            }
        };

        // 評量向度資料
        const dimensions = [
            {
                id: 'attitude',
                name: '上課態度',
                comments: {
                    encouraging: [
                        '還沒開始展現出學習的狀態{EXAMPLE}，沒關係，我們期待看到你下一次的參與與改變！',
                        '已經開始進入教室{EXAMPLE}，下一步是更專注地投入課程，相信你辦得到！',
                        '有時能專心、有時會分心{EXAMPLE}，你的參與是個起點，再加一點專注就更棒了！',
                        '上課態度穩定{EXAMPLE}，持續努力會讓你在課堂上更有自信。',
                        '上課表現穩定{EXAMPLE}，能積極回應老師、參與活動，是大家學習的榜樣之一。',
                        '總是全神貫注，積極發問與互動{EXAMPLE}，讓課堂因你而更有活力！'
                    ],
                    neutral: [
                        '目前在課堂參與方面尚待改進{EXAMPLE}，建議增加專注度。',
                        '開始在課堂中展現學習意願{EXAMPLE}，仍需持續投入。',
                        '上課態度表現不穩定{EXAMPLE}，時有分心情況。',
                        '上課態度基本穩定{EXAMPLE}，能維持適當的專注度。',
                        '上課表現良好{EXAMPLE}，能主動參與課堂活動和回應。',
                        '上課態度優秀{EXAMPLE}，持續展現高度專注和積極參與。'
                    ]
                }
            },
            {
                id: 'exam',
                name: '考試分數',
                comments: {
                    encouraging: [
                        '考試的出席率不理想{EXAMPLE}，希望下次能看到你勇敢地嘗試，讓我們一起迎接進步的開始！',
                        '雖然成績還不理想{EXAMPLE}，但你已經踏出第一步，每一題的嘗試都很有意義。',
                        '掌握了一些基礎內容{EXAMPLE}，繼續練習，相信會越來越熟悉！',
                        '在理解基礎概念上已有穩定的成果{EXAMPLE}，再多複習就能更上一層樓。',
                        '展現出良好的理解力{EXAMPLE}，已經能靈活運用知識，持續維持會更棒！',
                        '考試表現非常優秀{EXAMPLE}，代表你不只理解，更能靈活運用學到的知識，太棒了！'
                    ],
                    neutral: [
                        '考試出席情況需要改善{EXAMPLE}，建議積極參與測驗。',
                        '考試成績目前仍有進步空間{EXAMPLE}，需加強基礎概念理解。',
                        '已掌握部分基礎內容{EXAMPLE}，但仍需持續加強練習。',
                        '考試成績達到基本要求{EXAMPLE}，在基礎概念理解上表現穩定。',
                        '考試表現良好{EXAMPLE}，能有效理解和運用學習內容。',
                        '考試成績優異{EXAMPLE}，展現出扎實的知識基礎和應用能力。'
                    ]
                }
            },
            {
                id: 'notes',
                name: '筆記分數',
                comments: {
                    encouraging: [
                        '這次還沒有筆記的紀錄{EXAMPLE}，但下次開始動筆就會是很棒的開始！',
                        '有記下一些內容{EXAMPLE}，下一次可以試著抓出更多重點喔！',
                        '已開始記錄重要概念了{EXAMPLE}，若能更有條理，效果會更好。',
                        '筆記已有一定系統{EXAMPLE}，建議嘗試加些整理和自己的想法，會更有幫助。',
                        '筆記清楚、有條理{EXAMPLE}，學習的痕跡非常明顯，做得很好！',
                        '筆記不但完整{EXAMPLE}，而且有整理與延伸思考，是極具參考價值的作品！'
                    ],
                    neutral: [
                        '目前缺乏筆記記錄{EXAMPLE}，建議開始養成記錄習慣。',
                        '筆記內容較為簡略{EXAMPLE}，需要增加重點記錄的完整性。',
                        '已開始記錄重要概念{EXAMPLE}，但組織結構仍需改善。',
                        '筆記具有基本的系統性{EXAMPLE}，內容記錄適度。',
                        '筆記記錄清楚有條理{EXAMPLE}，能有效掌握學習重點。',
                        '筆記內容完整且具有個人整理和思考{EXAMPLE}，品質優良。'
                    ]
                }
            },
            {
                id: 'peer',
                name: '同儕關係',
                comments: {
                    encouraging: [
                        '與同學互動的機會還不多{EXAMPLE}，試著主動參與，相信會有不一樣的收穫！',
                        '正在學習如何與同儕相處{EXAMPLE}，偶爾會遇到挑戰，但這正是成長的契機。',
                        '與部分同學相處融洽{EXAMPLE}，再多一點主動互動，會讓你更融入班級喔。',
                        '能與大家和平相處{EXAMPLE}，表現出基本的合作與尊重，是值得肯定的！',
                        '樂於與人合作{EXAMPLE}，也能傾聽與溝通，是團體中的好夥伴！',
                        '是促進班級氣氛的關鍵人物{EXAMPLE}，總是帶來正面影響，讓同儕感到溫暖！'
                    ],
                    neutral: [
                        '與同學互動頻率較低{EXAMPLE}，建議增加主動參與班級活動。',
                        '在同儕相處方面仍在學習適應{EXAMPLE}，偶有互動上的困難。',
                        '與部分同學相處良好{EXAMPLE}，但整體社交參與度可再提升。',
                        '能與同學和平相處{EXAMPLE}，展現基本的合作態度和人際尊重。',
                        '同儕關係良好{EXAMPLE}，具備合作溝通能力，是班級中的協調者。',
                        '在班級中發揮正向影響力{EXAMPLE}，同儕關係和諧，社交能力優秀。'
                    ]
                }
            },
            {
                id: 'selflearn',
                name: '自主學習',
                comments: {
                    encouraging: [
                        '還沒展開自主學習的旅程{EXAMPLE}，沒關係，下一步是最重要的開始。',
                        '已經開始注意課業了{EXAMPLE}，若能自己安排一些練習，就更進步囉！',
                        '願意在需要時學習{EXAMPLE}，再多一些主動探索就能看見更大的進步。',
                        '能完成老師安排的任務{EXAMPLE}，若能主動延伸學習會更理想。',
                        '具備良好的學習規劃{EXAMPLE}，能掌握進度，也會找資源幫助自己學習。',
                        '展現出強烈的學習動力與責任感{EXAMPLE}，是自主學習的典範！'
                    ],
                    neutral: [
                        '自主學習能力尚待開發{EXAMPLE}，建議培養主動學習的習慣。',
                        '開始關注個人學習進度{EXAMPLE}，但自主安排練習的能力需要加強。',
                        '具有基本的學習自覺性{EXAMPLE}，但主動探索學習的積極度可再提升。',
                        '能按時完成指定作業{EXAMPLE}，自主延伸學習的表現有待加強。',
                        '展現良好的學習規劃能力{EXAMPLE}，能主動尋找學習資源並掌握進度。',
                        '自主學習能力優秀{EXAMPLE}，具備強烈的學習動機和良好的自我管理能力。'
                    ]
                }
            },
            {
                id: 'attendance',
                name: '生活常規（出缺席）',
                comments: {
                    encouraging: [
                        '缺席狀況較嚴重{EXAMPLE}，期待看到你的身影，一起加入我們的學習旅程！',
                        '已經開始穩定出席幾次課程{EXAMPLE}，這是一個很好的起點，繼續保持喔！',
                        '出席情況逐漸穩定了{EXAMPLE}，再多一點規律就更棒了，相信你做得到！',
                        '大多數時間都能準時到課{EXAMPLE}，表現出基本的責任感，是值得肯定的進步。',
                        '幾乎每次都準時出席課堂{EXAMPLE}，展現出穩定的學習態度與自律能力。',
                        '總是準時出席且有準備{EXAMPLE}，是時間管理與責任感的最佳典範！'
                    ],
                    neutral: [
                        '出缺席狀況需要改善{EXAMPLE}，建議建立規律的出席習慣。',
                        '開始穩定出席部分課程{EXAMPLE}，仍需持續改善出席率。',
                        '出席情況有所改善{EXAMPLE}，但仍需要更穩定的表現。',
                        '大多數時間能準時出席{EXAMPLE}，展現基本的責任感。',
                        '出席狀況良好{EXAMPLE}，能維持穩定的學習態度。',
                        '出席表現優秀{EXAMPLE}，展現出良好的時間管理與責任感。'
                    ]
                }
            }
        ];

        // 儲存分數狀態
        let scores = {};
        
        // 儲存具體事例
        let examples = {};
        
        // 儲存雷達圖實例
        let radarChart = null;

        // 初始化評量項目
        function initializeEvaluationItems() {
            const container = document.getElementById('evaluationItems');
            
            dimensions.forEach(dim => {
                const itemHTML = `
                    <div class="evaluation-item">
                        <div class="evaluation-header">
                            <span class="evaluation-title">${dim.name}</span>
                            <span class="score-display" id="score-${dim.id}">-</span>
                        </div>
                        <div class="score-buttons">
                            <button class="score-btn no-score" onclick="setScore('${dim.id}', null)">未評分</button>
                            ${[0, 1, 2, 3, 4, 5].map(score => 
                                `<button class="score-btn" onclick="setScore('${dim.id}', ${score})">${score}</button>`
                            ).join('')}
                        </div>
                        <div class="example-input-section">
                            <label class="example-label" for="example-${dim.id}">具體事例 (選填)</label>
                            <input type="text" id="example-${dim.id}" class="example-input" 
                                   placeholder="例如：上週主動幫助同學解題、段考期間認真複習、連續三週準時到課..." 
                                   onchange="setExample('${dim.id}', this.value)">
                            <small class="example-hint">輸入具體事例可讓評語更加個人化</small>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHTML;
            });
        }

        // 設定分數
        function setScore(dimensionId, score) {
            if (score === null) {
                delete scores[dimensionId];
                document.getElementById(`score-${dimensionId}`).textContent = '-';
            } else {
                scores[dimensionId] = score;
                document.getElementById(`score-${dimensionId}`).textContent = score;
            }
            
            // 更新按鈕狀態
            const buttons = document.querySelectorAll(`.evaluation-item:has(#score-${dimensionId}) .score-btn`);
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (score === null && btn.classList.contains('no-score')) {
                    btn.classList.add('active');
                } else if (btn.textContent === String(score)) {
                    btn.classList.add('active');
                }
            });
            
            // 如果是批量評分模式，即時保存到當前學生
            if (currentStudentIndex >= 0 && studentList.length > 0) {
                const studentName = studentList[currentStudentIndex];
                if (!studentScores[studentName]) {
                    studentScores[studentName] = {};
                }
                if (score !== null) {
                    studentScores[studentName][dimensionId] = score;
                } else {
                    delete studentScores[studentName][dimensionId];
                }
                
                // 更新學生列表顯示
                displayStudentList();
            }
        }

        // 設定具體事例
        function setExample(dimensionId, example) {
            if (example && example.trim()) {
                examples[dimensionId] = example.trim();
            } else {
                delete examples[dimensionId];
            }
            
            // 如果是批量評分模式，即時保存到當前學生
            if (currentStudentIndex >= 0 && studentList.length > 0) {
                const studentName = studentList[currentStudentIndex];
                if (!studentExamples[studentName]) {
                    studentExamples[studentName] = {};
                }
                if (example && example.trim()) {
                    studentExamples[studentName][dimensionId] = example.trim();
                } else {
                    delete studentExamples[studentName][dimensionId];
                }
            }
        }

        // 生成評語
        function generateComment() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (Object.keys(scores).length === 0) {
                alert('請至少評分一個向度');
                return;
            }
            
            // 取得選擇的語氣和風格
            const selectedTone = document.querySelector('input[name="commentTone"]:checked').value;
            const selectedStyle = document.querySelector('input[name="commentStyle"]:checked').value;
            
            // 將有分數的向度按分數高低排序
            const sortedDimensions = Object.entries(scores)
                .map(([dimId, score]) => {
                    const dim = dimensions.find(d => d.id === dimId);
                    let comment = dim.comments[selectedTone][score];
                    
                    // 處理具體事例的插入
                    if (examples[dimId]) {
                        comment = comment.replace('{EXAMPLE}', `，如${examples[dimId]}`);
                    } else {
                        comment = comment.replace('{EXAMPLE}', '');
                    }
                    
                    return {
                        id: dimId,
                        name: dim.name,
                        score: score,
                        comment: comment
                    };
                })
                .sort((a, b) => b.score - a.score);
            
            // 根據選擇的風格生成評語
            let comment = '';
            
            switch(selectedStyle) {
                case 'style1':
                    comment = generateStyle1(studentName, sortedDimensions, selectedTone);
                    break;
                case 'style2':
                    comment = generateStyle2(studentName, sortedDimensions, selectedTone);
                    break;
                case 'style3':
                    comment = generateStyle3(studentName, sortedDimensions, selectedTone);
                    break;
            }
            
            // 設定當前生成的評語
            currentGeneratedComment = comment;
            currentCommentType = 'scoring';
            
            // 顯示結果
            document.getElementById('commentText').textContent = comment;
            
            // 顯示未儲存狀態
            updateCommentStatus('unsaved');
            
            // 隱藏重新生成按鈕，顯示雷達圖
            document.getElementById('regenerateIdiomBtn').style.display = 'none';
            document.querySelector('.radar-chart-section').style.display = 'block';
            
            // 生成雷達圖
            generateRadarChart();
            
            document.getElementById('resultSection').classList.add('show');
            
            // 滾動到結果區域
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 風格一：多樣化銜接詞
        function generateStyle1(studentName, sortedDimensions, selectedTone) {
            let comment = studentName ? `${studentName}同學，` : '';
            
            const connectors = {
                attitude: ['在上課態度方面，', '上課態度上，', '課堂表現方面，'],
                exam: ['考試的表現顯示', '學習成果顯示', '測驗表現上，'],
                notes: ['關於筆記習慣，', '在筆記記錄上，', '學習筆記方面，'],
                peer: ['與同學相處上，', '在同儕互動方面，', '人際關係表現上，'],
                selflearn: ['至於自主學習，', '在自我學習部分，', '學習自主性方面，'],
                attendance: ['在生活常規方面，', '出缺席表現上，', '生活管理上，']
            };
            
            sortedDimensions.forEach((dim, index) => {
                const connector = connectors[dim.id][0];
                
                if (index === 0) {
                    comment += `${connector}${dim.comment}`;
                } else if (index === sortedDimensions.length - 1) {
                    comment += `另外，${connector}${dim.comment}`;
                } else {
                    comment += connector + dim.comment;
                }
            });
            
            // 根據語氣選擇不同的結尾
            const endings = {
                encouraging: '期待看到你持續的成長與進步！',
                neutral: '建議持續努力，期望未來能有更好的表現。'
            };
            
            comment += endings[selectedTone];
            return comment;
        }

        // 風格二：自然語句融合
        function generateStyle2(studentName, sortedDimensions, selectedTone) {
            let comment = studentName ? `${studentName}同學，` : '';
            
            const naturalPhrases = {
                attitude: {
                    high: '課堂上的你',
                    mid: '在學習過程中',
                    low: '未來在課堂上'
                },
                exam: {
                    high: '學習成果令人欣慰，',
                    mid: '學習成果顯示',
                    low: '在知識掌握上'
                },
                notes: {
                    high: '學習記錄相當用心，',
                    mid: '在記錄學習重點時',
                    low: '未來記錄學習內容時'
                },
                peer: {
                    high: '你',
                    mid: '與同學相處時',
                    low: '在班級互動中'
                },
                selflearn: {
                    high: '學習態度積極主動，',
                    mid: '此外，',
                    low: '在課後學習上'
                },
                attendance: {
                    high: '出席表現優異，',
                    mid: '在時間管理上',
                    low: '在出席規律上'
                }
            };
            
            sortedDimensions.forEach((dim, index) => {
                const level = dim.score >= 4 ? 'high' : (dim.score >= 2 ? 'mid' : 'low');
                const phrase = naturalPhrases[dim.id][level];
                
                if (index === 0) {
                    comment += `${phrase}${dim.comment}`;
                } else if (index === 1) {
                    comment += `同時，${phrase}${dim.comment}`;
                } else if (index === sortedDimensions.length - 1) {
                    comment += `${phrase}${dim.comment}`;
                } else {
                    comment += `${phrase}${dim.comment}`;
                }
            });
            
            // 根據語氣選擇不同的結尾
            const endings = {
                encouraging: '相信你會越來越進步！',
                neutral: '希望能持續保持學習的穩定度。'
            };
            
            comment += endings[selectedTone];
            return comment;
        }

        // 風格三：邏輯分組連接
        function generateStyle3(studentName, sortedDimensions, selectedTone) {
            let comment = studentName ? `${studentName}同學，` : '';
            
            // 將向度分組
            const groups = {
                classroom: [], // 課堂相關：態度、筆記
                performance: [], // 表現相關：考試、自主學習
                social: [], // 社交相關：同儕關係
                management: [] // 管理相關：出缺席
            };
            
            sortedDimensions.forEach(dim => {
                if (dim.id === 'attitude' || dim.id === 'notes') {
                    groups.classroom.push(dim);
                } else if (dim.id === 'exam' || dim.id === 'selflearn') {
                    groups.performance.push(dim);
                } else if (dim.id === 'peer') {
                    groups.social.push(dim);
                } else if (dim.id === 'attendance') {
                    groups.management.push(dim);
                }
            });
            
            let hasContent = false;
            
            // 生活管理表現
            if (groups.management.length > 0) {
                groups.management.forEach(dim => {
                    comment += `在生活管理上${dim.comment}`;
                });
                hasContent = true;
            }
            
            // 社交表現
            if (groups.social.length > 0) {
                if (hasContent) comment += '在班級中，';
                groups.social.forEach(dim => {
                    comment += `${dim.comment}`;
                });
                hasContent = true;
            }
            
            // 課堂表現
            if (groups.classroom.length > 0) {
                if (hasContent) comment += '學習方面，';
                groups.classroom.forEach((dim, index) => {
                    if (index === 0) {
                        comment += dim.comment;
                    } else {
                        comment += `同時${dim.comment}`;
                    }
                });
                hasContent = true;
            }
            
            // 學習成果
            if (groups.performance.length > 0) {
                if (hasContent) comment += '在學習成果上，';
                groups.performance.forEach((dim, index) => {
                    if (index === 0) {
                        comment += dim.comment;
                    } else {
                        comment += `而且${dim.comment}`;
                    }
                });
            }
            
            // 根據語氣選擇不同的結尾
            const endings = {
                encouraging: '繼續保持這樣的學習態度，一定會有更大的收穫！',
                neutral: '建議繼續維持目前的學習方向，並尋求進一步改善。'
            };
            
            comment += endings[selectedTone];
            return comment;
        }

        // 生成雷達圖
        function generateRadarChart() {
            // 準備雷達圖數據
            const dimensionNames = ['上課態度', '考試分數', '筆記分數', '同儕關係', '自主學習', '生活常規'];
            const dimensionIds = ['attitude', 'exam', 'notes', 'peer', 'selflearn', 'attendance'];
            
            const data = dimensionIds.map(id => scores[id] || 0);
            
            // 銷毀現有圖表
            if (radarChart) {
                radarChart.destroy();
            }
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: dimensionNames,
                    datasets: [{
                        label: '學生能力評分',
                        data: data,
                        backgroundColor: 'rgba(147, 112, 219, 0.2)',
                        borderColor: 'rgba(147, 112, 219, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(147, 112, 219, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            min: 0,
                            ticks: {
                                stepSize: 1,
                                display: true,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(147, 112, 219, 0.3)'
                            },
                            angleLines: {
                                color: 'rgba(147, 112, 219, 0.3)'
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }

        // 複製評語
        function copyComment() {
            const commentText = document.getElementById('commentText').textContent;
            
            navigator.clipboard.writeText(commentText).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = '已複製！';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = '複製評語';
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                // 舊版瀏覽器相容性處理
                const textArea = document.createElement('textarea');
                textArea.value = commentText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = '已複製！';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = '複製評語';
                    copyBtn.classList.remove('copied');
                }, 2000);
            });
        }

        // 重置表單
        function resetForm() {
            // 在批量評分模式下，詢問是否要重置所有資料
            if (studentList.length > 0) {
                const confirmReset = confirm('這將清除所有學生的評分資料，確定要重置嗎？');
                if (!confirmReset) return;
                
                // 重置批量評分資料
                studentList = [];
                studentScores = {};
                studentExamples = {};
                studentComments = {};
                currentStudentIndex = -1;
                currentGeneratedComment = '';
                currentCommentType = '';
                
                // 隱藏相關區域
                document.getElementById('studentListSection').classList.remove('show');
                document.getElementById('batchOverviewSection').classList.remove('show');
                document.getElementById('currentStudentIndicator').style.display = 'none';
                
                // 清空檔案上傳顯示
                document.getElementById('fileInfo').classList.remove('show');
                document.getElementById('fileInput').value = '';
                
                // 清空下拉選單和搜尋框
                document.getElementById('studentSelector').innerHTML = '<option value="">-- 請選擇學生 --</option>';
                document.getElementById('studentSearch').value = '';
            }
            
            // 清空學生姓名
            document.getElementById('studentName').value = '';
            
            // 重置所有分數
            scores = {};
            dimensions.forEach(dim => {
                setScore(dim.id, null);
            });
            
            // 清空所有具體事例
            examples = {};
            dimensions.forEach(dim => {
                document.getElementById(`example-${dim.id}`).value = '';
            });
            
            // 清空評語相關資料
            currentGeneratedComment = '';
            currentCommentType = '';
            if (studentList.length === 0) {
                studentComments = {};
            }
            
            // 清除雷達圖
            if (radarChart) {
                radarChart.destroy();
                radarChart = null;
            }
            
            // 隱藏結果區域
            document.getElementById('resultSection').classList.remove('show');
            
            // 滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 設定拖拽上傳功能
        function setupDragAndDrop() {
            const uploadSection = document.getElementById('fileUploadSection');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadSection.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadSection.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadSection.classList.add('dragover');
            }
            
            function unhighlight(e) {
                uploadSection.classList.remove('dragover');
            }
            
            uploadSection.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    document.getElementById('fileInput').files = files;
                    handleFileUpload({ target: { files: [file] } });
                }
            }
        }

        // 儲存選擇的成語
        let selectedIdioms = [];

        // 批量評分相關變數
        let studentList = [];
        let currentStudentIndex = -1;
        let studentScores = {}; // 儲存所有學生的評分數據
        let studentExamples = {}; // 儲存所有學生的具體事例
        let studentComments = {}; // 儲存所有學生的評語
        let currentGeneratedComment = ''; // 當前生成但未儲存的評語
        let currentCommentType = ''; // 當前評語類型（scoring/idioms）

        // 檔案上傳處理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 顯示檔案資訊
            displayFileInfo(file);

            // 根據檔案類型進行解析
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                parseCSVFile(file);
            } else if (fileExtension === 'xls' || fileExtension === 'xlsx') {
                parseExcelFile(file);
            } else {
                alert('不支援的檔案格式，請選擇 CSV、XLS 或 XLSX 檔案');
                return;
            }
        }

        // 顯示檔案資訊
        function displayFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileDetails = document.getElementById('fileDetails');
            
            fileName.textContent = file.name;
            fileDetails.textContent = `檔案大小: ${(file.size / 1024).toFixed(2)} KB | 檔案類型: ${file.type || '未知'}`;
            fileInfo.classList.add('show');
        }

        // 解析CSV檔案
        function parseCSVFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');
                const students = [];
                
                lines.forEach((line, index) => {
                    if (line.trim()) {
                        const columns = line.split(',');
                        const studentName = columns[0].trim().replace(/"/g, ''); // 移除可能的引號
                        if (studentName && studentName !== '' && index < 100) { // 限制最多100個學生
                            students.push(studentName);
                        }
                    }
                });
                
                if (students.length > 0) {
                    loadStudentList(students);
                } else {
                    alert('未在檔案中找到有效的學生姓名');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 解析Excel檔案
        function parseExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 讀取第一個工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 轉換為JSON格式
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    const students = [];
                    jsonData.forEach((row, index) => {
                        if (row[0] && typeof row[0] === 'string' && row[0].trim() !== '' && index < 100) {
                            students.push(row[0].trim());
                        }
                    });
                    
                    if (students.length > 0) {
                        loadStudentList(students);
                    } else {
                        alert('未在檔案中找到有效的學生姓名');
                    }
                } catch (error) {
                    console.error('解析Excel檔案時發生錯誤:', error);
                    alert('解析檔案時發生錯誤，請確認檔案格式正確');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 載入學生名單
        function loadStudentList(students) {
            studentList = [...new Set(students)]; // 去除重複項目
            studentScores = {};
            studentExamples = {};
            studentComments = {};
            currentStudentIndex = -1;
            currentGeneratedComment = '';
            currentCommentType = '';
            
            // 初始化所有學生的評分資料
            studentList.forEach(student => {
                studentScores[student] = {};
                studentExamples[student] = {};
                studentComments[student] = null;
            });
            
            displayStudentList();
            
            // 清除搜尋輸入框
            document.getElementById('studentSearch').value = '';
            
            // 顯示學生列表區域
            document.getElementById('studentListSection').classList.add('show');
            
            // 滾動到學生列表
            document.getElementById('studentListSection').scrollIntoView({ behavior: 'smooth' });
            
            alert(`成功匯入 ${studentList.length} 位學生的名單！`);
        }

        // 顯示學生列表
        function displayStudentList() {
            const studentSelector = document.getElementById('studentSelector');
            const studentCount = document.getElementById('studentCount');
            
            studentCount.textContent = `共 ${studentList.length} 位學生`;
            
            // 清空並重新填充下拉選單
            studentSelector.innerHTML = '<option value="">-- 請選擇學生 --</option>';
            
            studentList.forEach((student, index) => {
                const option = document.createElement('option');
                option.value = index;
                
                const isScored = Object.keys(studentScores[student]).length > 0;
                const hasComment = studentComments[student] !== null;
                const isActive = index === currentStudentIndex;
                
                let statusIcon = '';
                let statusText = '';
                let dataStatus = '';
                
                if (isActive) {
                    statusIcon = '🔵';
                    statusText = '評分中';
                    dataStatus = 'active';
                } else if (hasComment) {
                    statusIcon = '🟢';
                    statusText = '已完成';
                    dataStatus = 'completed';
                } else if (isScored) {
                    statusIcon = '🟡';
                    statusText = '已評分';
                    dataStatus = 'rated';
                } else {
                    statusIcon = '🔴';
                    statusText = '未評分';
                    dataStatus = 'unrated';
                }
                
                option.textContent = `${statusIcon} ${student} (${statusText})`;
                option.setAttribute('data-status', dataStatus);
                option.setAttribute('data-name', student.toLowerCase());
                
                if (isActive) {
                    option.selected = true;
                }
                
                studentSelector.appendChild(option);
            });
            
            // 更新統計資訊
            updateStudentStats();
        }

        // 更新學生統計資訊
        function updateStudentStats() {
            let unratedCount = 0;
            let ratedCount = 0;
            let completedCount = 0;
            
            studentList.forEach(student => {
                const isScored = Object.keys(studentScores[student]).length > 0;
                const hasComment = studentComments[student] !== null;
                
                if (hasComment) {
                    completedCount++;
                } else if (isScored) {
                    ratedCount++;
                } else {
                    unratedCount++;
                }
            });
            
            const completionRate = studentList.length > 0 ? 
                Math.round((completedCount / studentList.length) * 100) : 0;
            
            document.getElementById('unratedCount').textContent = unratedCount;
            document.getElementById('ratedCount').textContent = ratedCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('completionRate').textContent = `${completionRate}%`;
        }

        // 處理下拉選單學生選擇
        function handleStudentSelection(selectedValue) {
            if (selectedValue === '') {
                return;
            }
            
            const index = parseInt(selectedValue);
            selectStudent(index);
        }

        // 處理搜尋輸入框鍵盤事件
        function handleSearchKeydown(event) {
            if (event.key === 'Enter') {
                const searchTerm = event.target.value.toLowerCase().trim();
                if (searchTerm) {
                    // 尋找完全匹配的學生
                    const exactMatch = studentList.find(student => 
                        student.toLowerCase() === searchTerm
                    );
                    
                    if (exactMatch) {
                        const index = studentList.indexOf(exactMatch);
                        selectStudent(index);
                        event.target.value = '';
                        filterStudents('');
                    } else {
                        // 尋找部分匹配的第一個學生
                        const partialMatch = studentList.find(student => 
                            student.toLowerCase().includes(searchTerm)
                        );
                        
                        if (partialMatch) {
                            const index = studentList.indexOf(partialMatch);
                            selectStudent(index);
                            event.target.value = '';
                            filterStudents('');
                        }
                    }
                }
            } else if (event.key === 'Escape') {
                event.target.value = '';
                filterStudents('');
                event.target.blur();
            }
        }

        // 學生搜尋過濾
        function filterStudents(searchTerm) {
            const studentSelector = document.getElementById('studentSelector');
            const options = studentSelector.querySelectorAll('option');
            
            searchTerm = searchTerm.toLowerCase().trim();
            
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    return;
                }
                
                const studentName = option.getAttribute('data-name');
                if (studentName && studentName.includes(searchTerm)) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // 如果搜尋結果只有一個學生，自動選擇
            const visibleOptions = Array.from(options).filter(option => 
                option.value !== '' && option.style.display !== 'none'
            );
            
            if (visibleOptions.length === 1 && searchTerm.length > 0) {
                const exactMatch = visibleOptions.find(option => 
                    option.getAttribute('data-name') === searchTerm
                );
                if (exactMatch) {
                    studentSelector.value = exactMatch.value;
                    handleStudentSelection(exactMatch.value);
                    document.getElementById('studentSearch').value = '';
                    filterStudents(''); // 清除篩選，顯示所有選項
                }
            }
        }

        // 選擇學生進行評分
        function selectStudent(index) {
            if (index < 0 || index >= studentList.length) return;
            
            // 儲存當前學生的評分資料
            if (currentStudentIndex >= 0) {
                saveCurrentStudentData();
            }
            
            // 切換到新學生
            currentStudentIndex = index;
            const studentName = studentList[index];
            
            // 更新界面
            document.getElementById('studentName').value = studentName;
            document.getElementById('currentStudentName').textContent = studentName;
            document.getElementById('currentStudentIndicator').style.display = 'block';
            
            // 載入學生的評分資料
            loadStudentData(studentName);
            
            // 更新學生列表顯示
            displayStudentList();
            
            // 更新下拉選單選擇
            document.getElementById('studentSelector').value = index;
            
            // 滾動到評分區域
            document.querySelector('.input-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 儲存當前學生的評分資料
        function saveCurrentStudentData() {
            if (currentStudentIndex >= 0) {
                const studentName = studentList[currentStudentIndex];
                studentScores[studentName] = { ...scores };
                studentExamples[studentName] = { ...examples };
            }
        }

        // 載入學生的評分資料
        function loadStudentData(studentName) {
            // 清空當前評分
            scores = {};
            examples = {};
            currentGeneratedComment = '';
            currentCommentType = '';
            
            // 載入學生的評分資料
            if (studentScores[studentName]) {
                scores = { ...studentScores[studentName] };
            }
            if (studentExamples[studentName]) {
                examples = { ...studentExamples[studentName] };
            }
            
            // 更新界面
            dimensions.forEach(dim => {
                const score = scores[dim.id];
                if (score !== undefined) {
                    setScore(dim.id, score);
                } else {
                    setScore(dim.id, null);
                }
                
                const example = examples[dim.id] || '';
                document.getElementById(`example-${dim.id}`).value = example;
            });
            
            // 載入已儲存的評語
            loadSavedComment(studentName);
        }

        // 載入已儲存的評語
        function loadSavedComment(studentName) {
            const savedComment = studentComments[studentName];
            const resultSection = document.getElementById('resultSection');
            const commentStatus = document.getElementById('commentStatus');
            
            if (savedComment) {
                // 顯示已儲存的評語
                document.getElementById('commentText').textContent = savedComment.content;
                
                // 顯示評語狀態
                updateCommentStatus('saved', savedComment);
                
                // 顯示結果區域
                if (savedComment.type === 'idioms') {
                    document.getElementById('regenerateIdiomBtn').style.display = 'inline-block';
                    document.querySelector('.radar-chart-section').style.display = 'none';
                } else {
                    document.getElementById('regenerateIdiomBtn').style.display = 'none';
                    document.querySelector('.radar-chart-section').style.display = 'block';
                    generateRadarChart();
                }
                
                resultSection.classList.add('show');
            } else {
                // 隱藏結果區域
                resultSection.classList.remove('show');
                commentStatus.style.display = 'none';
            }
        }

        // 更新評語狀態顯示
        function updateCommentStatus(status, commentData = null) {
            const commentStatus = document.getElementById('commentStatus');
            const commentStatusText = document.getElementById('commentStatusText');
            const commentMetadata = document.getElementById('commentMetadata');
            const saveBtn = document.getElementById('saveCommentBtn');
            
            commentStatus.style.display = 'block';
            commentStatus.className = 'comment-status ' + status;
            
            if (status === 'saved' && commentData) {
                commentStatusText.textContent = '評語已儲存';
                const typeText = commentData.type === 'idioms' ? '四字成語版本' : '六向度評分版本';
                const timeText = new Date(commentData.timestamp).toLocaleString('zh-TW');
                commentMetadata.textContent = `類型：${typeText} | 儲存時間：${timeText}`;
                saveBtn.disabled = true;
                saveBtn.textContent = '已儲存';
            } else if (status === 'unsaved') {
                commentStatusText.textContent = '評語已生成，但尚未儲存';
                commentMetadata.textContent = '請點擊「儲存評語」按鈕以保存到學生資料中';
                saveBtn.disabled = false;
                saveBtn.textContent = '儲存評語';
            }
        }

        // 儲存當前評語
        function saveCurrentComment() {
            if (!currentGeneratedComment || !currentCommentType) {
                alert('沒有可儲存的評語');
                return;
            }
            
            const studentName = document.getElementById('studentName').value.trim();
            if (!studentName) {
                alert('請先選擇或輸入學生姓名');
                return;
            }
            
            // 如果是批量評分模式，確保學生在列表中
            if (studentList.length > 0 && !studentList.includes(studentName)) {
                alert('該學生不在已匯入的名單中');
                return;
            }
            
            // 儲存評語
            const commentData = {
                content: currentGeneratedComment,
                type: currentCommentType,
                timestamp: new Date().toISOString(),
                studentName: studentName
            };
            
            // 初始化學生資料（如果是單獨評分）
            if (studentList.length === 0) {
                if (!studentComments[studentName]) {
                    studentComments[studentName] = null;
                }
            }
            
            studentComments[studentName] = commentData;
            
            // 更新狀態顯示
            updateCommentStatus('saved', commentData);
            
            // 更新學生列表顯示（如果在批量模式）
            if (studentList.length > 0) {
                displayStudentList();
            } else {
                // 單獨評分模式也更新統計
                updateStudentStats();
            }
            
            alert('評語已成功儲存！');
        }

        // 版本切換功能
        function switchVersion() {
            const versionRadios = document.querySelectorAll('input[name="commentVersion"]');
            const scoringSection = document.getElementById('scoringSection');
            const idiomsSection = document.getElementById('idiomsSection');
            
            versionRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'scoring') {
                        scoringSection.style.display = 'block';
                        idiomsSection.style.display = 'none';
                    } else if (this.value === 'idioms') {
                        scoringSection.style.display = 'none';
                        idiomsSection.style.display = 'block';
                    }
                });
            });
        }

        // 生成四字成語評語
        function generateIdiomComment() {
            // 收集選中的類別
            const selectedCategories = [];
            const checkboxes = document.querySelectorAll('#idiomsSection input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('請至少選擇一個評語類別');
                return;
            }
            
            selectedIdioms = [];
            
            checkboxes.forEach(checkbox => {
                const categoryItem = checkbox.closest('.category-item');
                const category = categoryItem.dataset.category;
                const subcategory = checkbox.dataset.subcategory;
                
                if (idiomData[category] && idiomData[category][subcategory]) {
                    const idioms = idiomData[category][subcategory];
                    const randomIdiom = idioms[Math.floor(Math.random() * idioms.length)];
                    selectedIdioms.push(randomIdiom);
                }
            });
            
            // 生成最終評語
            const comment = generateFinalIdiomComment(selectedIdioms);
            
            // 設定當前生成的評語
            currentGeneratedComment = comment;
            currentCommentType = 'idioms';
            
            // 顯示結果
            document.getElementById('commentText').textContent = comment;
            
            // 顯示未儲存狀態
            updateCommentStatus('unsaved');
            
            // 顯示重新生成按鈕，隱藏雷達圖
            document.getElementById('regenerateIdiomBtn').style.display = 'inline-block';
            document.querySelector('.radar-chart-section').style.display = 'none';
            
            document.getElementById('resultSection').classList.add('show');
            
            // 滾動到結果區域
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // 生成最終的四字成語評語
        function generateFinalIdiomComment(idioms) {
            if (idioms.length === 0) return '';
            
            // 直接顯示選中的成語
            return idioms.join('、');
        }

        // 切換批量總覽顯示
        function toggleBatchOverview() {
            const overviewSection = document.getElementById('batchOverviewSection');
            const isVisible = overviewSection.classList.contains('show');
            
            if (isVisible) {
                overviewSection.classList.remove('show');
            } else {
                // 儲存當前學生的評分資料
                saveCurrentStudentData();
                
                // 更新總覽表格
                updateBatchOverview();
                
                // 顯示總覽
                overviewSection.classList.add('show');
                overviewSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // 更新批量總覽表格
        function updateBatchOverview() {
            const tableBody = document.querySelector('#overviewTable tbody');
            tableBody.innerHTML = '';
            
            studentList.forEach((student, index) => {
                const row = document.createElement('tr');
                const studentData = studentScores[student] || {};
                const commentData = studentComments[student];
                
                // 計算已評分的向度數量
                const scoredDimensions = Object.keys(studentData).length;
                const totalDimensions = dimensions.length;
                
                // 評語狀態
                let commentStatus = '-';
                let commentType = '-';
                if (commentData) {
                    commentStatus = '已儲存';
                    commentType = commentData.type === 'idioms' ? '四字成語' : '六向度評分';
                } else if (scoredDimensions > 0) {
                    commentStatus = '可生成';
                }
                
                row.innerHTML = `
                    <td class="student-name-cell" onclick="selectStudent(${index})">${student}</td>
                    <td class="score-cell ${studentData.attitude !== undefined ? 'scored' : 'unscored'}">${studentData.attitude !== undefined ? studentData.attitude : '-'}</td>
                    <td class="score-cell ${studentData.exam !== undefined ? 'scored' : 'unscored'}">${studentData.exam !== undefined ? studentData.exam : '-'}</td>
                    <td class="score-cell ${studentData.notes !== undefined ? 'scored' : 'unscored'}">${studentData.notes !== undefined ? studentData.notes : '-'}</td>
                    <td class="score-cell ${studentData.peer !== undefined ? 'scored' : 'unscored'}">${studentData.peer !== undefined ? studentData.peer : '-'}</td>
                    <td class="score-cell ${studentData.selflearn !== undefined ? 'scored' : 'unscored'}">${studentData.selflearn !== undefined ? studentData.selflearn : '-'}</td>
                    <td class="score-cell ${studentData.attendance !== undefined ? 'scored' : 'unscored'}">${studentData.attendance !== undefined ? studentData.attendance : '-'}</td>
                    <td class="score-cell ${commentData ? 'scored' : 'unscored'}">${commentStatus}</td>
                    <td class="score-cell ${commentData ? 'scored' : 'unscored'}">${commentType}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // 匯出結果
        function exportResults() {
            if (studentList.length === 0) {
                alert('沒有學生資料可以匯出');
                return;
            }
            
            // 儲存當前學生的評分資料
            saveCurrentStudentData();
            
            // 準備匯出資料
            const exportData = [];
            
            // 添加標題行
            const headers = ['學生姓名', '上課態度', '考試分數', '筆記分數', '同儕關係', '自主學習', '生活常規', '已評分向度', '評語類型', '儲存的評語', '生成時間'];
            exportData.push(headers);
            
            // 添加學生資料
            studentList.forEach(student => {
                const studentData = studentScores[student] || {};
                const commentData = studentComments[student];
                
                const scoredDimensions = Object.keys(studentData).length;
                const totalDimensions = dimensions.length;
                
                // 使用已儲存的評語，如果沒有則為空
                let comment = '';
                let commentType = '';
                let saveTime = '';
                
                if (commentData) {
                    comment = commentData.content;
                    commentType = commentData.type === 'idioms' ? '四字成語版本' : '六向度評分版本';
                    saveTime = new Date(commentData.timestamp).toLocaleString('zh-TW');
                }
                
                const row = [
                    student,
                    studentData.attitude !== undefined ? studentData.attitude : '',
                    studentData.exam !== undefined ? studentData.exam : '',
                    studentData.notes !== undefined ? studentData.notes : '',
                    studentData.peer !== undefined ? studentData.peer : '',
                    studentData.selflearn !== undefined ? studentData.selflearn : '',
                    studentData.attendance !== undefined ? studentData.attendance : '',
                    `${scoredDimensions}/${totalDimensions}`,
                    commentType,
                    comment,
                    saveTime
                ];
                
                exportData.push(row);
            });
            
            // 轉換為CSV格式並下載
            downloadCSV(exportData, '學生評分結果.csv');
        }

        // 生成學生評語
        function generateStudentComment(studentName, studentData, studentExampleData) {
            if (Object.keys(studentData).length === 0) return '';
            
            // 模擬生成評語的過程
            const selectedTone = 'encouraging'; // 預設使用鼓勵語氣
            const selectedStyle = 'style1'; // 預設使用風格一
            
            // 將有分數的向度按分數高低排序
            const sortedDimensions = Object.entries(studentData)
                .map(([dimId, score]) => {
                    const dim = dimensions.find(d => d.id === dimId);
                    let comment = dim.comments[selectedTone][score];
                    
                    // 處理具體事例的插入
                    if (studentExampleData[dimId]) {
                        comment = comment.replace('{EXAMPLE}', `，如${studentExampleData[dimId]}`);
                    } else {
                        comment = comment.replace('{EXAMPLE}', '');
                    }
                    
                    return {
                        id: dimId,
                        name: dim.name,
                        score: score,
                        comment: comment
                    };
                })
                .sort((a, b) => b.score - a.score);
            
            // 使用風格一生成評語
            return generateStyle1(studentName, sortedDimensions, selectedTone);
        }

        // 下載CSV檔案
        function downloadCSV(data, filename) {
            const csvContent = data.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('評分結果已成功匯出！');
        }

        // 重新生成成語（保持相同類別，但隨機選擇不同成語）
        function regenerateIdioms() {
            const checkboxes = document.querySelectorAll('#idiomsSection input[type="checkbox"]:checked');
            
            if (checkboxes.length === 0) {
                alert('請先選擇評語類別');
                return;
            }
            
            generateIdiomComment();
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeEvaluationItems();
            switchVersion();
            setupDragAndDrop();
            
            // 為每個向度設定預設未評分狀態
            dimensions.forEach(dim => {
                setScore(dim.id, null);
                setExample(dim.id, '');
            });
        });
    </script>
</body>
</html>